import*as e from"three";let canvas=document.querySelector("#canvasThree"),radiusSlider=document.querySelector("#radiusSlider"),radiusText=document.querySelector("#radiusText");radiusSlider.addEventListener("input",function(){let e=this.value/1e3;parameters.radius=e,radiusText.textContent="Ακτίνα: "+(100*e).toFixed(1).toString().replace(".",",")+" cm",obj.scale.setScalar(parameters.radius/.02)});let massSlider=document.querySelector("#massSlider"),massText=document.querySelector("#massText");massSlider.addEventListener("input",function(){let e=this.value/100;parameters.mass=e,massText.textContent="Μάζα: "+Math.round(1e3*e)+" gr",lengthSlider.dispatchEvent(new Event("input"))});let gravitySlider=document.querySelector("#gravitySlider"),gravityText=document.querySelector("#gravityText");gravitySlider.addEventListener("input",function(){let e=this.value/100;parameters.gravity=-e,gravityText.textContent="g: "+e.toFixed(2).toString().replace(".",",")+" m/s\xb2"});let lengthSlider=document.querySelector("#lengthSlider"),lengthText=document.querySelector("#lengthText");lengthSlider.addEventListener("input",function(){let e=this.value/100;if(parameters.length=e,lengthText.textContent="Μήκος: "+Math.round(100*e)+" cm",solidRod){let t=parameters.mass+parameters.rodMass,o=1*parameters.rodMass/2+parameters.mass*parameters.length;o/=t;let r=1/3*parameters.rodMass*1,a=parameters.mass*parameters.length*parameters.length;object.leq=(r+a)/t/o;let n=Math.atan(-object.x/(object.topP-object.y)),i=distanceString()-parameters.length;object.x+=Math.sin(n)*i,object.y+=Math.cos(n)*i,obj.position.x=object.x,obj.position.y=object.y}else object.leq=parameters.length});let rulerShow=document.querySelector("#rulerShow");rulerShow.addEventListener("change",function(){rulerShow.checked?scene.add(angle):scene.remove(angle)});let pressureSlider=document.querySelector("#pressureSlider"),pressureText=document.querySelector("#pressureText");pressureSlider.addEventListener("input",function(){let e=this.value/10;parameters.pressure=e,pressureText.textContent="Πίεση: "+e.toFixed(1).toString().replace(".",",")+" atm"});let rodShow=document.querySelector("#rodShow");rodShow.addEventListener("change",function(){rodShow.checked?(scene.add(rod),scene.remove(rope),solidRod=!0):(scene.remove(rod),scene.add(rope),solidRod=!1),lengthSlider.dispatchEvent(new Event("input"))});let timeSlider=document.querySelector("#timeSlider"),timeText=document.querySelector("#timeText");timeSlider.addEventListener("input",function(){let e=this.value/2;parameters.time=e,timeText.textContent="Χρόνος: "+e.toFixed(1).toString().replace(".",",")+"x"});let oscSlider=document.querySelector("#oscSlider"),oscText=document.querySelector("#oscText"),oscTimeText=document.querySelector("#oscTimeText");oscSlider.addEventListener("input",function(){parameters.oscillations=this.value,oscText.textContent="Ταλαντώσεις: "+Math.round(this.value),oscTimeText.textContent="0/"+Math.round(this.value)+"   0.000s",parameters.timeCounter=0,parameters.oscilationCounter=-.1,counting=!1}),document.body.addEventListener("change",function(e){let t=e.target;switch(t.id){case"radio2":parameters.maxError=2;break;case"radio5":parameters.maxError=5;break;case"radio10":parameters.maxError=10}});let resetButton=document.querySelector("#resetButton");resetButton.addEventListener("click",function(){parameters.oscilationCounter=0,parameters.timeCounter=0,counting=!0,parameters.errorFactor=1+(Math.random()-.5)*parameters.maxError/100*2});let renderer=new e.WebGLRenderer({antialias:!0,canvas});renderer.shadowMap.enabled=!0;let object={x:0,y:.105-.02+.3,ux:0,uy:0,topP:1.205,leq:1},parameters={gravity:-9.81,mass:.5,length:1,radius:.03,pressure:1,rodMass:.1,time:1,oscillations:10,timeCounter:0,oscilationCounter:-.1,maxError:2,errorFactor:1},holding=!1,solidRod=!1,counting=!1,moveMouse=new e.Vector2,clickMouse=new e.Vector2,raycaster=new e.Raycaster,fov=75,aspect=4/3,near=.1,far=10,camera=new e.PerspectiveCamera(75,aspect,.1,10);camera.position.z=1.15,camera.position.y=.6-.2,camera.position.x=0;let scene=new e.Scene,color=16777215,intensity=2,light=new e.DirectionalLight(16777215,2);light.position.set(0,2,2),light.lookAt(0,0,0),scene.add(light);let lightAmbient=new e.AmbientLight(10066329);scene.add(lightAmbient);let geometryPlane=new e.BoxGeometry(5,5,.001),materialPlane=new e.MeshPhongMaterial({color:4500104,transparent:!0}),plane=new e.Mesh(geometryPlane,materialPlane);scene.add(plane),plane.position.y=.6,plane.material.opacity=0;let geometry=new e.SphereGeometry(parameters.radius,32,16),material=new e.MeshPhongMaterial({color:4500104}),obj=new e.Mesh(geometry,material);scene.add(obj),obj.position.y=.105-parameters.radius+.3,obj.position.x=0,addStand();let[rope,ropeData]=createRope(parameters.length,100);function addStand(){let t=object.topP,o=new e.CylinderGeometry(.01,.01,t,32),r=new e.MeshPhongMaterial({color:8421504}),a=new e.Mesh(o,r);scene.add(a),a.position.y=t/2,a.position.x=0,a.position.z=-.1;let n=new e.BoxGeometry(.02,.01,.11),i=new e.MeshPhongMaterial({color:9474192}),s=new e.Mesh(n,i);scene.add(s),s.position.y=t,s.position.x=0,s.position.z=-.05;let l=new e.BoxGeometry(.13,.01,.13);new e.MeshPhongMaterial({color:8421504});let $=new e.Mesh(l,r);scene.add($),$.position.z=-.05}scene.add(rope);let angle;function addAngleMeter(){let t=document.createElement("canvas"),o=t.getContext("2d"),r;t.width=1100,t.height=1100,o.clearRect(0,0,t.height,t.height),o.beginPath(),o.fillStyle="rgba(256, 256, 256, 0.1)",o.strokeStyle="rgba(0, 0, 0, 1)",o.font="35px Arial",o.arc(t.width,0,t.width/1.1,0,2*Math.PI),o.rect(t.width,0,-t.width,t.height),o.closePath(),o.fill(),o.fillStyle="rgba(0, 0, 256, 0.1)";for(let a=0;a<3;a++){for(let n=0;n<=90;n+=10)$(n,30,t.width/1.1);for(let i=0;i<=90;i+=5)$(i,20,t.width/1.1);for(let s=0;s<=90;s+=1)$(s,10,t.width/1.1);for(let l=10;l<90;l+=10)c(l,80,t.width/1.1)}function $(e,r,a){let n=a*Math.sin(e*=Math.PI/180),i=t.width-a*Math.cos(e),s=(a+r)*Math.sin(e),l=t.width-(a+r)*Math.cos(e);o.beginPath(),o.moveTo(i,n),o.lineTo(l,s),o.stroke()}function c(e,r,a){let n=Math.PI/180*e,i=t.width-(a+r)*Math.cos(n);o.fillText(90-e,i,(a+r)*Math.sin(n))}r=new e.CanvasTexture(t);let d=new e.BoxGeometry(1.205,1.205,.001,32),p=new e.MeshBasicMaterial({map:r,transparent:!0});(angle=new e.Mesh(d,p)).position.x=-.6025,angle.position.y=.6025}addAngleMeter();let rod;function createSolidRod(){let t=new e.CylinderGeometry(.005,.005,1.01,32),o=new e.MeshPhongMaterial({color:14540253});(rod=new e.Mesh(t,o)).position.y=object.topP-.505,rod.position.x=0,rod.position.z=0}function resizeCanvas(){canvas.style.width="100%",canvas.style.height="100%";let e=canvas.clientWidth,t=canvas.clientHeight;canvas.width=e,canvas.height=t,renderer.setSize(canvas.width,canvas.height),camera.updateProjectionMatrix()}function calculateObjectPosition(e){if(e=e>500?500:e,e/=1e3,!0!=holding){for(let t=0;t<100;t++)positionStep(e/100);obj.position.x=object.x,object.y>=object.topP&&(object.y=object.topP,object.ux=0,object.uy=0),obj.position.y=object.y}}function positionStep(e){let t={x:0,y:parameters.gravity*parameters.mass};t.y*=parameters.length/object.leq;let o=(!0==solidRod?1e4:1e3)*(distanceString()-parameters.length);o=o>0?o:0;let r=Math.atan(-object.x/(object.topP-object.y));if(t.x+=Math.sin(r)*o,t.y+=Math.cos(r)*o,o){let a=-50*(Math.sin(r)*object.ux+Math.cos(r)*object.uy);t.x+=Math.sin(r)*a,t.y+=Math.cos(r)*a}let n=.3055*parameters.radius*parameters.radius*Math.PI*parameters.pressure;n*=solidRod?1.5:2,t.x+=-object.ux*Math.abs(object.ux)*n-object.ux*n,t.y+=-object.uy*Math.abs(object.uy)*n-object.ux*n,object.ux+=t.x/parameters.mass*e,object.uy+=t.y/parameters.mass*e,object.x+=object.ux*e,object.y+=object.uy*e}createSolidRod(),window.addEventListener("resize",function(){resizeCanvas()});let oldTime=0;function render(e){let t=e-oldTime;oldTime=e;let o=object.x;if(calculateObjectPosition(t*parameters.time),counting&&(o/object.x<0&&(parameters.oscilationCounter+=.5,Math.round(parameters.oscilationCounter)>=Math.round(parameters.oscillations)&&(counting=!1)),parameters.timeCounter+=t*parameters.errorFactor*parameters.time,oscTimeText.textContent=Math.round(parameters.oscilationCounter)+"/"+Math.round(parameters.oscillations)+"   "+(parameters.timeCounter/1e3).toFixed(3).toString().replace(".",",")+"s"),solidRod)updateRod(Math.atan(object.x/(object.topP-object.y)));else{let r;updateRope(ropeData,{x:0,y:object.topP},{x:object.x,y:object.y})}renderer.render(scene,camera),requestAnimationFrame(render)}function distanceString(){let e=object.x,t=object.y,o=object.topP;return Math.sqrt((e-0)*(e-0)+(t-o)*(t-o))-parameters.radius}function createRope(t,o){let r=[],a=[],n=t/o;for(let i=0;i<=o;i++){let s={x:0,y:i*n,z:0,lx:0,ly:i*n,lz:0};r.push(new e.Vector3(s.x,s.y,0)),a.push(s)}let l=new e.BufferGeometry().setFromPoints(r),$=new e.LineBasicMaterial({color:16777215}),c=new e.Line(l,$);return[c,a]}function updateRope(e,t,o){let r=e.length-1,a=parameters.length/r*.8,n=1e-4*parameters.gravity*parameters.time;for(let i=0;i<=r;i++){let s=e[i].x+(e[i].x-e[i].lx)*.99,l=e[i].y+(e[i].y-e[i].ly)*.99+n,$=e[i].z+(e[i].z-e[i].lz)*.99;e[i].lx=e[i].x,e[i].x=s,e[i].ly=e[i].y,e[i].y=l,e[i].lz=e[i].z,e[i].z=$}for(let c=0;c<100;c++){e[0].x=t.x,e[0].y=t.y,e[r].x=o.x,e[r].y=o.y;for(let d=0;d<r;d++){let p=e[d],u=e[d+1],m=distanceBetweenPoints(p.x,p.y,p.z,u.x,u.y,u.z),y=(a-m)/m/2,x=(u.x-p.x)*y,h=(u.y-p.y)*y,_=(u.z-p.z)*y;p.x-=x,p.y-=h,p.z-=_,e[d].x=p.x,e[d].y=p.y,e[d].z=p.z,u.x+=x,u.y+=h,u.z+=_,e[d+1].x=u.x,e[d+1].y=u.y,e[d+1].z=u.z}}for(let b=0;b<r;b++)if(distanceString()/parameters.length>.99){let g=Math.atan(object.x/(object.topP-object.y)),j=a/.78*b*Math.sin(g),S=-a/.78*b*Math.cos(g)+t.y;rope.geometry.attributes.position.setXYZ(b,j,S,0)}else rope.geometry.attributes.position.setXYZ(b,e[b].x,e[b].y,e[b].z);rope.geometry.attributes.position.setXYZ(r,object.x,object.y,0),rope.geometry.attributes.position.needsUpdate=!0}function distanceBetweenPoints(e,t,o,r,a,n){return Math.sqrt((e-r)*(e-r)+(t-a)*(t-a)+(o-n)*(o-n))}function updateRopeCat(e,t,o){let r=e.length-1;e[0].x=o.x,e[0].y=o.y,e[0].z=0,rope.geometry.attributes.position.setXYZ(0,o.x,o.y,0),e[r].x=t.x,e[r].y=t.y,e[r].z=0,rope.geometry.attributes.position.setXYZ(r,t.x,t.y,0);let a=1,n=parameters.length+parameters.radius+.01,i=t.y-o.y,s=Math.abs(o.x);s<=.01&&(s=.01);for(let l=0;l<10;l++){let $=1/Math.sqrt(2*a*Math.sinh(.5/a)-1)-1/Math.sqrt(Math.sqrt(n*n-i*i)/s-1),c=(.5/a*Math.cosh(.5/a)-Math.sinh(.5/a))/Math.pow(2*a*Math.sinh(.5/a)-1,1.5);a-=$/c}for(let d=1;d<r;d++){let p=d/r*s,u=a*s*Math.cosh(p/a/s);e[d].x=p,e[d].y=u}for(let m=1;m<r;m++)rope.geometry.attributes.position.setXYZ(m,e[m].x,e[m].y,e[m].z)}function updateRopeSec(e,t,o){let r=e.length-1;e[0].x=o.x,e[0].y=o.y,e[0].z=0,rope.geometry.attributes.position.setXYZ(0,o.x,o.y,0),e[r].x=t.x,e[r].y=t.y,e[r].z=0,rope.geometry.attributes.position.setXYZ(r,t.x,t.y,0);let a=1,n=parameters.length+parameters.radius+.01,i=t.y-o.y,s=Math.abs(o.x);s<=.01&&(s=.01);for(let l=0;l<10;l++){let $=1/Math.sqrt(2*a*Math.sinh(.5/a)-1)-1/Math.sqrt(Math.sqrt(n*n-i*i)/s-1),c=(.5/a*Math.cosh(.5/a)-Math.sinh(.5/a))/Math.pow(2*a*Math.sinh(.5/a)-1,1.5);a-=$/c}for(let d=1;d<r;d++){let p=d/r*s,u=a*s*Math.cosh(p/a/s);e[d].x=p,e[d].y=u}for(let m=1;m<r;m++)rope.geometry.attributes.position.setXYZ(m,e[m].x,e[m].y,e[m].z)}function updateRod(e){rod.rotation.z=e,rod.position.x=Math.sin(e)/2,rod.position.y=object.topP-Math.cos(e)/2}requestAnimationFrame(render),resizeCanvas(),window.addEventListener("mousedown",e=>{raycaster.setFromCamera(moveMouse,camera);let t=raycaster.intersectObject(obj);t.length&&(holding=!0,object.ux=0,object.uy=0)}),window.addEventListener("mouseup",e=>{holding=!1}),canvas.addEventListener("mouseleave",e=>{holding=!1}),window.addEventListener("mousemove",e=>{if(moveMouse.x=e.clientX/window.innerWidth*2-1,moveMouse.x*=window.innerWidth/canvas.width,moveMouse.y=-(2*(e.clientY/canvas.height))+1,holding){raycaster.setFromCamera(moveMouse,camera);let t=raycaster.intersectObject(plane);if(obj.position.x=t[0].point.x,object.x=t[0].point.x,obj.position.y=t[0].point.y,object.y=t[0].point.y,t[0].point.y>object.topP&&(obj.position.y=object.topP,object.y=object.topP),distanceString()>parameters.length){let o=Math.atan(-object.x/(object.topP-object.y)),r=distanceString()-parameters.length;object.x+=Math.sin(o)*r,object.y+=Math.cos(o)*r,obj.position.x=object.x,obj.position.y=object.y}if(solidRod){let a=Math.atan(-object.x/(object.topP-object.y)),n=distanceString()-parameters.length;object.x+=Math.sin(a)*n,object.y+=Math.cos(a)*n,obj.position.x=object.x,obj.position.y=object.y}}});